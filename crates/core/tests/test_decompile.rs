//! Integration tests for decompile functionality.

#[cfg(test)]
mod integration_tests {
    use std::path::PathBuf;

    use alloy_json_abi::JsonAbi;
    use heimdall_decompiler::{decompile, DecompilerArgs, DecompilerArgsBuilder};
    use serde_json::Value;

    #[tokio::test]
    async fn test_decompile_precompile() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let result = decompile(DecompilerArgs {
            target: String::from("0x1bf797219482a29013d804ad96d1c6f84fba4c45"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");

        // assert that the output is correct
        for line in &["function Unresolved_19045a25(uint256 arg0, uint256 arg1) public payable returns (address) {",
            " = ecrecover("] {
            println!("{line}");
            assert!(result.source.as_ref().expect("decompile source is empty").contains(line));
        }
    }

    #[tokio::test]
    async fn test_decompile_edge_case_u256_conversion_overflow_1() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let _ = decompile(DecompilerArgs {
            target: String::from("0x914d7Fec6aaC8cd542e72Bca78B30650d45643d7"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");
    }

    #[tokio::test]
    async fn test_decompile_edge_case_u256_conversion_overflow_2() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let _ = decompile(DecompilerArgs {
            target: String::from("0x5141b82f5ffda4c6fe1e372978f1c5427640a190"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");
    }

    #[tokio::test]
    async fn test_decompile_edge_case_vec_overflow() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let _ = decompile(DecompilerArgs {
            target: String::from("0x8579970692bf77fafeeb017f07dec9a8fdb4893d"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");
    }

    #[tokio::test]
    async fn test_decompile_weth() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let result = decompile(DecompilerArgs {
            target: String::from("0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");

        // assert that the output is correct
        for line in &[
            "function Unresolved_095ea7b3(address arg0, uint256 arg1) public returns (bool) {",
            "function Unresolved_18160ddd() public view returns (uint256) {",
            "function Unresolved_23b872dd(address arg0, address arg1, uint256 arg2) public returns (bool) {",
            "function Unresolved_2e1a7d4d(uint256 arg0) public {",
            "function Unresolved_70a08231(address arg0) public view returns (uint256) {",
            "function Unresolved_a9059cbb(address arg0, uint256 arg1) public returns (bool) {",
            "function Unresolved_d0e30db0() public payable {",
            "function Unresolved_dd62ed3e(address arg0, address arg1) public view returns (uint256) {"] {
            println!("{line}");
            assert!(result.source.as_ref().expect("decompile source is empty").contains(line));
        }
    }

    #[tokio::test]
    async fn test_decompile_ctf() {
        let rpc_url = std::env::var("RPC_URL").unwrap_or_else(|_| {
            println!("RPC_URL not set, skipping test");
            std::process::exit(0);
        });

        let result = decompile(DecompilerArgs {
            target: String::from("0x9f00c43700bc0000Ff91bE00841F8e04c0495000"),
            rpc_url,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,
        })
        .await
        .expect("failed to decompile");

        // assert that the output is correct
        for line in &["function Unresolved_2fa61cd8(address arg0) public view returns (uint16) {",
            "function Unresolved_41161b10(uint240 arg0, address arg1) public payable returns (bool) {",
            "constant unresolved_06fdde03"] {
            println!("{line}");
            assert!(result.source.as_ref().expect("decompile source is empty").contains(line));
        }
    }

    #[tokio::test]
    async fn test_decompile_vyper() {
        let result = decompile(DecompilerArgs {
            target: String::from("0x5f3560e01c63fdf80bda811861005d57602436103417610061576004358060a01c610061576040525f5c6002146100615760025f5d6040515a595f5f36365f8537835f8787f1905090509050610057573d5f5f3e3d5ffd5b60035f5d005b5f5ffd5b5f80fd"),
            rpc_url: String::from(""),
            default: true,
            skip_resolving: true,
            include_solidity: false,
            include_yul: true,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,

        })
        .await
        .expect("failed to decompile");

        // assert that the output is correct
        for line in &[
            "default {",
            "if eq(0x02, tload(0)) { revert(0, 0); } else {",
            "tstore(0, 0x02)",
            "call(gas(), mload(0x40), 0, msize(), calldatasize(), 0, 0)",
        ] {
            println!("{line}");
            assert!(result.source.as_ref().expect("decompile source is empty").contains(line));
        }
    }

    #[tokio::test]
    async fn test_decompile_clamping() {
        // NOTE: this test is only checking for runtime. decompilation *must* finish within 5
        // seconds, or the test fails.
        let start = std::time::Instant::now();
        let _ = decompile(DecompilerArgs {
            target: String::from("0x608060405260043610610183575f3560e01c80637d6a4568116100d5578063b761ed3c1161007e578063cc7b4f8b11610058578063cc7b4f8b14610694578063d9c45357146106b3578063f2fde38b146106c65761018a565b8063b761ed3c1461061b578063bf298c341461063a578063c683630d146106595761018a565b80639ccfd8c1116100af5780639ccfd8c1146105aa578063ad5c4648146105c9578063b171d294146105fc5761018a565b80637d6a4568146105215780638b674f5d146105625780638da5cb5b146105815761018a565b80633334e66311610137578063715018a611610111578063715018a6146104cf578063774b6b7e146104e357806378e3214f146105025761018a565b80633334e663146104725780633d4a345c14610485578063460690f4146104a45761018a565b80630b129abf116101685780630b129abf146103f1578063263cc4fd1461043257806333320de3146104535761018a565b806303a18fa31461037757806308f2cc54146103b95761018a565b3661018a57005b348015610195575f5ffd5b505f80357fffffffff0000000000000000000000000000000000000000000000000000000016815260036020908152604080832054815136601f8101859004850282018501909352828152919260609273ffffffffffffffffffffffffffffffffffffffff90921691859182908690819084018382808284375f92019190915250929350505073ffffffffffffffffffffffffffffffffffffffff831690506102c8577f61f598cd000000000000000000000000000000000000000000000000000000005f819052600360209081527fd56a229876ba4a58895db4a079f0d0efdde0ead5de385f5ccf8d9ca2e29196865490830180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1690921790915273ffffffffffffffffffffffffffffffffffffffff1691505b5f5f8373ffffffffffffffffffffffffffffffffffffffff16836040516102ef919061281b565b5f60405180830381855af49150503d805f8114610327576040519150601f19603f3d011682016040523d82523d5f602084013e61032c565b606091505b509150915081610368576040517f221f615800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b80519650602001945050505050f35b348015610382575f5ffd5b506001546103a39073ffffffffffffffffffffffffffffffffffffffff1681565b6040516103b09190612852565b60405180910390f35b3480156103c4575f5ffd5b506103e46103d336600461287e565b60076020525f908152604090205481565b6040516103b091906128aa565b3480156103fc575f5ffd5b506103a361040b3660046128eb565b60046020525f908152604090205473ffffffffffffffffffffffffffffffffffffffff1681565b34801561043d575f5ffd5b5061045161044c36600461287e565b6106e5565b005b34801561045e575f5ffd5b5061045161046d366004612abe565b610734565b610451610480366004612d5f565b6107ec565b348015610490575f5ffd5b5061045161049f366004612e89565b610b5b565b3480156104af575f5ffd5b506103e46104be36600461287e565b60066020525f908152604090205481565b3480156104da575f5ffd5b50610451610c5e565b3480156104ee575f5ffd5b506104516104fd366004612f3b565b610c71565b34801561050d575f5ffd5b5061045161051c366004612fb9565b610e4c565b34801561052c575f5ffd5b506103a361053b3660046128eb565b60036020525f908152604090205473ffffffffffffffffffffffffffffffffffffffff1681565b34801561056d575f5ffd5b5061045161057c366004612fe9565b610e9e565b34801561058c575f5ffd5b505f5473ffffffffffffffffffffffffffffffffffffffff166103a3565b3480156105b5575f5ffd5b506104516105c436600461302e565b610f37565b3480156105d4575f5ffd5b506103a37f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc281565b348015610607575f5ffd5b50610451610616366004612fb9565b610fb5565b348015610626575f5ffd5b5061045161063536600461305e565b611084565b348015610645575f5ffd5b50610451610654366004612e89565b6110cc565b348015610664575f5ffd5b5061068761067336600461287e565b60056020525f908152604090205460ff1681565b6040516103b09190613084565b34801561069f575f5ffd5b506104516106ae366004612fb9565b6111cf565b6104516106c1366004612fe9565b611290565b3480156106d1575f5ffd5b506104516106e036600461287e565b61130c565b6106ed611376565b600180547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055565b61073c611376565b8051825114610749575f5ffd5b5f5b82518110156107e75781818151811061076657610766613092565b602002602001015160055f85848151811061078357610783613092565b60209081029190910181015173ffffffffffffffffffffffffffffffffffffffff1682528101919091526040015f2080547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff001691151591909117905560010161074b565b505050565b8142811015610827576040517f203d82d800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b335f9081526005602052604090205460ff1661086f576040517f584a793800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff87160361091e577f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc273ffffffffffffffffffffffffffffffffffffffff1663d0e30db0346040518263ffffffff1660e01b81526004015f604051808303818588803b158015610906575f5ffd5b505af1158015610918573d5f5f3e3d5ffd5b50505050505b5f5b87518110156109a0575f5f5b89838151811061093e5761093e613092565b6020026020010151518110156109965761098c8a848151811061096357610963613092565b6020026020010151828151811061097c5761097c613092565b60200260200101518385846113c6565b915060010161092c565b5050600101610920565b505f6109ab8661162d565b905073eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff871603610ab057805f036109eb575f610a0f565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff01805b506040517f2e1a7d4d00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc21690632e1a7d4d90610a829084906004016128aa565b5f604051808303815f87803b158015610a99575f5ffd5b505af1158015610aab573d5f5f3e3d5ffd5b505050505b825115610ac557610ac283878361176d565b90505b5f610acf8861162d565b9050610b118887835f03610ae3575f610b0a565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff90930192835b6001611946565b610b508787845f03610b23575f610b4a565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff90940193845b5f611946565b505050505050505050565b610b63611376565b8051825114610b9e576040517f1df89e8b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5b82518110156107e757818181518110610bbb57610bbb613092565b602002602001015160045f858481518110610bd857610bd8613092565b6020908102919091018101517fffffffff000000000000000000000000000000000000000000000000000000001682528101919091526040015f2080547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055600101610ba0565b610c66611376565b610c6f5f611a43565b565b335f9081526005602052604090205460ff16610cb9576040517f584a793800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f610cc38561162d565b905073eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff861603610dc857805f03610d03575f610d27565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff01805b506040517f2e1a7d4d00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc21690632e1a7d4d90610d9a9084906004016128aa565b5f604051808303815f87803b158015610db1575f5ffd5b505af1158015610dc3573d5f5f3e3d5ffd5b505050505b8115610e1357610e1083838080601f0160208091040260200160405190810160405280939291908181526020018383808284375f9201919091525089925085915061176d9050565b90505b5f610e1d8761162d565b9050610e318786835f03610ae3575f610b0a565b610e438686845f03610b23575f610b4a565b50505050505050565b610e54611376565b73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff831603610e9357610e8f3382611ab7565b5050565b610e8f823383611b72565b335f9081526005602052604090205460ff16610ee6576040517f584a793800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f610ef3828401846130bf565b90505f5f5b8251811015610f3057610f26838281518110610f1657610f16613092565b6020026020010151835f846113c6565b9150600101610ef8565b5050505050565b610f3f611376565b7fffffffff00000000000000000000000000000000000000000000000000000000919091165f90815260046020526040902080547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff909216919091179055565b610fbd611376565b73ffffffffffffffffffffffffffffffffffffffff821661100a576040517fe6c4247b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8015806110265750612710811115801561102657506113888110155b61105c576040517f2757d13000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b73ffffffffffffffffffffffffffffffffffffffff9091165f90815260066020526040902055565b61108c611376565b60648110156110c7576040517fd3800fe100000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600255565b6110d4611376565b805182511461110f576040517f1df89e8b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f5b82518110156107e75781818151811061112c5761112c613092565b602002602001015160035f85848151811061114957611149613092565b6020908102919091018101517fffffffff000000000000000000000000000000000000000000000000000000001682528101919091526040015f2080547fffffffffffffffffffffffff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff92909216919091179055600101611111565b6111d7611376565b73ffffffffffffffffffffffffffffffffffffffff8216611224576040517fe6c4247b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b801580611232575060648110155b611268576040517f2757d13000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b73ffffffffffffffffffffffffffffffffffffffff9091165f90815260076020526040902055565b335f9081526005602052604090205460ff166112d8576040517f584a793800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f6112e5828401846131c2565b90506107e7815f015182602001518360400151846060015185608001518660a001516107ec565b611314611376565b73ffffffffffffffffffffffffffffffffffffffff811661136a576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161136190613256565b60405180910390fd5b61137381611a43565b50565b5f5473ffffffffffffffffffffffffffffffffffffffff163314610c6f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113619061329a565b5f7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff841061141c576040517ffd4babfc00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6020808601517fffffffff0000000000000000000000000000000000000000000000000000000081165f9081526004909252604090912054819073ffffffffffffffffffffffffffffffffffffffff16806114a3576040517fdec9523700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60e08263ffffffff16901b871796505f5f8273ffffffffffffffffffffffffffffffffffffffff16858b5f01518b6040516020016114e29291906132f9565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529082905261151e9291602001613341565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0818403018152908290526115569161281b565b5f60405180830381855af49150503d805f811461158e576040519150601f19603f3d011682016040523d82523d5f602084013e611593565b606091505b50915091508161160b576115d8816115aa8a611c9b565b6115b38a611c9b565b6040516020016115c492919061335c565b604051602081830303815290604052611d58565b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113619190613413565b8080602001905181019061161f919061342f565b9a9950505050505050505050565b5f73eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff831603611716576040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc216906370a08231906116d1903090600401612852565b602060405180830381865afa1580156116ec573d5f5f3e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611710919061342f565b92915050565b6040517f70a0823100000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff8316906370a08231906116d1903090600401612852565b919050565b5f5f611779858461215e565b604081015160208201519192500180156119395780840393508160a001515f0361180657608082015173ffffffffffffffffffffffffffffffffffffffff16156117d1576117d185836080015184602001515f611946565b815173ffffffffffffffffffffffffffffffffffffffff16156118015761180185835f015184604001515f611946565b611874565b8160a0015160010361184257608082015173ffffffffffffffffffffffffffffffffffffffff161561180157611801858360800151835f611946565b6040517f2e573a3f00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b815f015173ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16836080015173ffffffffffffffffffffffffffffffffffffffff167f4bc8151c051441255339d01fbaeb38cf109cbfd75e9a5c62fb8f1dfb37fe6fd68486604001516040516118f592919061344d565b60405180910390a47fbf402572f7d269fcae3a56e497d9fc9459e32213d9286c383ad57fa2b532fa8f8260a0015160405161193091906128aa565b60405180910390a15b83925050505b9392505050565b8115611a3d5773eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee73ffffffffffffffffffffffffffffffffffffffff851603611a32578015611a23576040517f2e1a7d4d00000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc21690632e1a7d4d906119f59085906004016128aa565b5f604051808303815f87803b158015611a0c575f5ffd5b505af1158015611a1e573d5f5f3e3d5ffd5b505050505b611a2d8383611ab7565b611a3d565b611a3d848484611b72565b50505050565b5f805473ffffffffffffffffffffffffffffffffffffffff8381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b805f03611ac2575050565b604080515f8082526020820190925273ffffffffffffffffffffffffffffffffffffffff8416908390604051611af8919061281b565b5f6040518083038185875af1925050503d805f8114611b32576040519150601f19603f3d011682016040523d82523d5f602084013e611b37565b606091505b50509050806107e7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611361906134c1565b805f03611b7e57505050565b5f5f8473ffffffffffffffffffffffffffffffffffffffff1663a9059cbb8585604051602401611baf9291906134d1565b6040516020818303038152906040529060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611bfd919061281b565b5f604051808303815f865af19150503d805f8114611c36576040519150601f19603f3d011682016040523d82523d5f602084013e611c3b565b606091505b5091509150818015611c65575080511580611c65575080806020019051810190611c6591906134ea565b610f30576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113619061353b565b60605f611ca78361245c565b60010190505f8167ffffffffffffffff811115611cc657611cc6612909565b6040519080825280601f01601f191660200182016040528015611cf0576020820181803683370190505b5090508181016020015b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff017f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a8504945084611cfa575b509392505050565b60606044835110158015611dc45750825f81518110611d7957611d79613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f0800000000000000000000000000000000000000000000000000000000000000145b8015611e29575082600181518110611dde57611dde613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167fc300000000000000000000000000000000000000000000000000000000000000145b8015611e8e575082600281518110611e4357611e43613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f7900000000000000000000000000000000000000000000000000000000000000145b8015611ef3575082600381518110611ea857611ea8613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167fa000000000000000000000000000000000000000000000000000000000000000145b15611f6f57604483810180519091611f0b9190613578565b84511015611f45576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611361906135be565b8281604051602001611f589291906135fa565b604051602081830303815290604052915050611710565b82516024148015611fd85750825f81518110611f8d57611f8d613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f4e00000000000000000000000000000000000000000000000000000000000000145b801561203d575082600181518110611ff257611ff2613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f4800000000000000000000000000000000000000000000000000000000000000145b80156120a257508260028151811061205757612057613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f7b00000000000000000000000000000000000000000000000000000000000000145b80156121075750826003815181106120bc576120bc613092565b6020910101517fff00000000000000000000000000000000000000000000000000000000000000167f7100000000000000000000000000000000000000000000000000000000000000145b1561212c5760248301518261211b8261253d565b604051602001611f58929190613673565b8161213684612563565b604051602001612147929190613689565b604051602081830303815290604052905092915050565b6121bd6040518060c001604052805f73ffffffffffffffffffffffffffffffffffffffff1681526020015f81526020015f81526020015f81526020015f73ffffffffffffffffffffffffffffffffffffffff1681526020015f81525090565b6020835111156123bf575f838060200190518101906121dc9190613728565b905060808160200151901c81602001516fffffffffffffffffffffffffffffffff16018311156123b95760408082015173ffffffffffffffffffffffffffffffffffffffff16608084018190525f90815260066020529081205490819003612270576040517f584a793800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b815161ffff1660a0840152815160101c69ffffffffffffffffffff6127108390038116908216106122a55781612710036122a7565b805b835160601c8086526020808601515f92835260079091526040909120549192506fffffffffffffffffffffffffffffffff1686039080156122f75761271087820204808311156122f5578092505b505b612710828502046020870152855173ffffffffffffffffffffffffffffffffffffffff1661232b57602086018290526123a2565b856080015173ffffffffffffffffffffffffffffffffffffffff16865f015173ffffffffffffffffffffffffffffffffffffffff16036123895760208601805161271069ffffffffffffffffffff86168502040190525f86526123a2565b61271069ffffffffffffffffffff841683020460408701525b506040850151602086015190910303606085015250505b50611710565b8251602003611710575f838060200190518101906123dd919061342f565b9050608081901c816fffffffffffffffffffffffffffffffff1601831115612455576fffffffffffffffffffffffffffffffff8116830360208301819052600254612710908502049081101561243557602083018190525b5060015473ffffffffffffffffffffffffffffffffffffffff1660808301525b5092915050565b5f807a184f03e93ff9f4daa797ed6e38ed64bf6a1f01000000000000000083106124a4577a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000830492506040015b6d04ee2d6d415b85acef810000000083106124d0576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc1000083106124ee57662386f26fc10000830492506010015b6305f5e1008310612506576305f5e100830492506008015b612710831061251a57612710830492506004015b6064831061252c576064830492506002015b600a83106117105760010192915050565b6060611710826040516020016125539190613746565b6040516020818303038152906040525b80516060907f3031323334353637383961626364656600000000000000000000000000000000905f9061259790600261375a565b6125a2906002613578565b67ffffffffffffffff8111156125ba576125ba612909565b6040519080825280601f01601f1916602001820160405280156125e4576020820181803683370190505b5090507f3000000000000000000000000000000000000000000000000000000000000000815f8151811061261a5761261a613092565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a9053507f78000000000000000000000000000000000000000000000000000000000000008160018151811061267c5761267c613092565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a9053505f5b8451811015611d50578260048683815181106126ca576126ca613092565b01602001517fff0000000000000000000000000000000000000000000000000000000000000016901c60f81c6010811061270657612706613092565b1a60f81b8261271683600261375a565b612721906002613578565b8151811061273157612731613092565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a9053508285828151811061277257612772613092565b60209101015160f81c600f166010811061278e5761278e613092565b1a60f81b8261279e83600261375a565b6127a9906003613578565b815181106127b9576127b9613092565b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a9053506001016126ac565b8281835e505f910152565b5f612803825190565b6128118185602086016127ef565b9290920192915050565b5f61193f82846127fa565b5f73ffffffffffffffffffffffffffffffffffffffff8216611710565b61284c81612826565b82525050565b602081016117108284612843565b61286981612826565b8114611373575f5ffd5b803561171081612860565b5f60208284031215612891576128915f5ffd5b5f61289c8484612873565b949350505050565b8061284c565b6020810161171082846128a4565b7fffffffff000000000000000000000000000000000000000000000000000000008116612869565b8035611710816128b8565b5f602082840312156128fe576128fe5f5ffd5b5f61289c84846128e0565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f830116810181811067ffffffffffffffff8211171561297a5761297a612909565b6040525050565b5f61298b60405190565b90506117688282612936565b5f67ffffffffffffffff8211156129b0576129b0612909565b5060209081020190565b5f6129cc6129c784612997565b612981565b838152905060208082019084028301858111156129ea576129ea5f5ffd5b835b81811015612a0e57806129ff8882612873565b845250602092830192016129ec565b5050509392505050565b5f82601f830112612a2a57612a2a5f5ffd5b813561289c8482602086016129ba565b801515612869565b803561171081612a3a565b5f612a5a6129c784612997565b83815290506020808201908402830185811115612a7857612a785f5ffd5b835b81811015612a0e5780612a8d8882612a42565b84525060209283019201612a7a565b5f82601f830112612aae57612aae5f5ffd5b813561289c848260208601612a4d565b5f5f60408385031215612ad257612ad25f5ffd5b823567ffffffffffffffff811115612aeb57612aeb5f5ffd5b612af785828601612a18565b925050602083013567ffffffffffffffff811115612b1657612b165f5ffd5b612b2285828601612a9c565b9150509250929050565b5f67ffffffffffffffff821115612b4557612b45612909565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011660200192915050565b82818337505f910152565b5f612b8c6129c784612b2c565b905082815260208101848484011115612ba657612ba65f5ffd5b611d50848285612b74565b5f82601f830112612bc357612bc35f5ffd5b813561289c848260208601612b7f565b80612869565b803561171081612bd3565b5f60408284031215612bf757612bf75f5ffd5b612c016040612981565b9050813567ffffffffffffffff811115612c1c57612c1c5f5ffd5b612c2884828501612bb1565b8252506020612c3984848301612bd9565b60208301525092915050565b5f612c526129c784612997565b83815290506020808201908402830185811115612c7057612c705f5ffd5b835b81811015612a0e57803567ffffffffffffffff811115612c9357612c935f5ffd5b808601612ca08982612be4565b8552505060209283019201612c72565b5f82601f830112612cc257612cc25f5ffd5b813561289c848260208601612c45565b5f612cdf6129c784612997565b83815290506020808201908402830185811115612cfd57612cfd5f5ffd5b835b81811015612a0e57803567ffffffffffffffff811115612d2057612d205f5ffd5b808601612d2d8982612cb0565b8552505060209283019201612cff565b5f82601f830112612d4f57612d4f5f5ffd5b813561289c848260208601612cd2565b5f5f5f5f5f5f60c08789031215612d7757612d775f5ffd5b863567ffffffffffffffff811115612d9057612d905f5ffd5b612d9c89828a01612d3d565b9650506020612dad89828a01612873565b9550506040612dbe89828a01612873565b9450506060612dcf89828a01612873565b9350506080612de089828a01612bd9565b92505060a087013567ffffffffffffffff811115612dff57612dff5f5ffd5b612e0b89828a01612bb1565b9150509295509295509295565b5f612e256129c784612997565b83815290506020808201908402830185811115612e4357612e435f5ffd5b835b81811015612a0e5780612e5888826128e0565b84525060209283019201612e45565b5f82601f830112612e7957612e795f5ffd5b813561289c848260208601612e18565b5f5f60408385031215612e9d57612e9d5f5ffd5b823567ffffffffffffffff811115612eb657612eb65f5ffd5b612ec285828601612e67565b925050602083013567ffffffffffffffff811115612ee157612ee15f5ffd5b612b2285828601612a18565b5f5f83601f840112612f0057612f005f5ffd5b50813567ffffffffffffffff811115612f1a57612f1a5f5ffd5b602083019150836001820283011115612f3457612f345f5ffd5b9250929050565b5f5f5f5f5f60808688031215612f5257612f525f5ffd5b5f612f5d8888612873565b9550506020612f6e88828901612873565b9450506040612f7f88828901612873565b935050606086013567ffffffffffffffff811115612f9e57612f9e5f5ffd5b612faa88828901612eed565b92509250509295509295909350565b5f5f60408385031215612fcd57612fcd5f5ffd5b5f612fd88585612873565b9250506020612b2285828601612bd9565b5f5f60208385031215612ffd57612ffd5f5ffd5b823567ffffffffffffffff811115613016576130165f5ffd5b61302285828601612eed565b92509250509250929050565b5f5f60408385031215613042576130425f5ffd5b5f61304d85856128e0565b9250506020612b2285828601612873565b5f60208284031215613071576130715f5ffd5b5f61289c8484612bd9565b80151561284c565b60208101611710828461307c565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f602082840312156130d2576130d25f5ffd5b813567ffffffffffffffff8111156130eb576130eb5f5ffd5b61289c84828501612cb0565b5f60c0828403121561310a5761310a5f5ffd5b61311460c0612981565b9050813567ffffffffffffffff81111561312f5761312f5f5ffd5b61313b84828501612d3d565b825250602061314c84848301612873565b602083015250604061316084828501612873565b604083015250606061317484828501612873565b606083015250608061318884828501612bd9565b60808301525060a082013567ffffffffffffffff8111156131aa576131aa5f5ffd5b6131b684828501612bb1565b60a08301525092915050565b5f602082840312156131d5576131d55f5ffd5b813567ffffffffffffffff8111156131ee576131ee5f5ffd5b61289c848285016130f7565b602681525f602082017f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206181527f6464726573730000000000000000000000000000000000000000000000000000602082015291505b5060400190565b60208082528101611710816131fa565b60208082527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657291019081525f5b5060200190565b6020808252810161171081613266565b5f6132b3825190565b8084526020840193506132ca8185602086016127ef565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920192915050565b6040808252810161330a81856132aa565b905061193f60208301846128a4565b7fffffffff00000000000000000000000000000000000000000000000000000000811661284c565b5f61334c8285613319565b60048201915061289c82846127fa565b7f7377617053696e676c65506f6f6c206661696c65642061742073657175656e6381527f653a20000000000000000000000000000000000000000000000000000000000060208201526023015f6133b382856127fa565b7f20686f703a200000000000000000000000000000000000000000000000000000815260060191506133e582846127fa565b7f3a200000000000000000000000000000000000000000000000000000000000008152600201949350505050565b6020808252810161193f81846132aa565b805161171081612bd3565b5f60208284031215613442576134425f5ffd5b5f61289c8484613424565b6040810161345b82856128a4565b61193f60208301846128a4565b602381525f602082017f5472616e7366657248656c7065723a204554485f5452414e534645525f46414981527f4c454400000000000000000000000000000000000000000000000000000000006020820152915061324f565b6020808252810161171081613468565b6040810161345b8285612843565b805161171081612a3a565b5f602082840312156134fd576134fd5f5ffd5b5f61289c84846134df565b601f81525f602082017f5472616e7366657248656c7065723a205452414e534645525f4641494c45440081529150613293565b6020808252810161171081613508565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b808201808211156117105761171061354b565b601581525f602082017f496e76616c69642072657665727420726561736f6e000000000000000000000081529150613293565b602080825281016117108161358b565b7f4572726f7228000000000000000000000000000000000000000000000000000081525f5b5060060190565b5f61360582856127fa565b9150613610826135ce565b915061361c82846127fa565b7f2900000000000000000000000000000000000000000000000000000000000000815291506001820161289c565b7f50616e696328000000000000000000000000000000000000000000000000000081525f6135f3565b5f61367e82856127fa565b91506136108261364a565b5f61369482856127fa565b7f556e6b6e6f776e280000000000000000000000000000000000000000000000008152915060088201613610565b805161171081612860565b5f606082840312156136e0576136e05f5ffd5b6136ea6060612981565b90505f6136f78484613424565b825250602061370884848301613424565b602083015250604061371c848285016136c2565b60408301525092915050565b5f6060828403121561373b5761373b5f5ffd5b5f61289c84846136cd565b5f61375182846128a4565b50602001919050565b8181028082158382048514176124555761245561354b56fea26469706673582212206caceb7d8f3e31d1c356ad67ffac65465e1d4098c754000ea26df795da861b5464736f6c634300081c0033"),
            rpc_url: String::from(""),
            default: true,
            skip_resolving: true,
            include_solidity: false,
            include_yul: true,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,

        })
        .await
        .expect("failed to decompile");

        // assert that runtime <= 3000 ms
        let end = std::time::Instant::now();
        let runtime = end.duration_since(start);
        assert!(runtime.as_millis() <= 3000, "decompile took too long: {} ms", runtime.as_millis());
    }

    #[tokio::test]
    async fn test_decompile_huff() {
        let result = decompile(DecompilerArgs {
            target: String::from("0x5f3560e01c806306fdde03146100295780632fa61cd81461004457806341161b1014610058575f5ffd5b60205f52684c61627972696e7468602952600960205260605ff35b6004355f524360205260405f205f5260205ff35b6004356024355f5f61020d565b60016100b2565b61021f57610149565b806100f9565b5f6100ca565b61012d57610278565b086101c7565b61012d57610249565b60026100e6565b526101b3565b806100f2565b82610114565b5f6100a0565b016100c4565b91610154565b906101c1565bf35b60016100ec565b6010610108565b836101a7565b9361017d565b146101f7565b01610100565b6001610234565b6003610143565b9161014f565bf35b83610159565b0261013d565b60ff61019b565b10610240565b836101cd565b1661023a565b602061026c565b6101ba576100a6565b1c610255565b1461027e565b80610099565b61024f565b61024f565b066101a1565b036100be565b16610192565b90610226565b81610272565b916101e1565b106101e8565b016101db565b6100655761016b565b61012d576100ac565b14610189565b15610090565b1c61022d565b15610134565b602061007b565b6010610171565b50610213565b15610081565b600161008a565b600261010e565b80610206565b6010610183565b61012d5761025c565b91610267565b6100d357610075565b806100e0565b60ff61011b565b82610261565b61020d565b600161015f565b6010610121565b60016100b8565b6001610165565b1461006c565b806101ad565b61012d576101f1565b91610218565b846100da565b6003610127565b61024f565b816101d4565b61024f565b5f610106565b03610200565b916100cc565b61017757"),
            rpc_url: String::from(""),
            default: true,
            skip_resolving: true,
            include_solidity: false,
            include_yul: true,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,
            openai_api_key: String::from(""),
            llm_postprocess: false,

        })
        .await
        .expect("failed to decompile");

        // assert that the output is correct
        for line in &["case 0x41161b10", "case 0x06fdde03", "mstore(0, 0x01)", "return(0, 0x20)"] {
            println!("{line}");
            assert!(result.source.as_ref().expect("decompile source is empty").contains(line));
        }
    }

    #[tokio::test]
    async fn test_decompile_base_edge_case_abi() {
        let _ = decompile(DecompilerArgs {
            target: String::from("0x6080604052600436101561001257600080fd5b6000803560e01c8062fdd58e1461327e57806301ffc9a7146131f557806302fa7c471461317957806306fdde03146130a25780630a7e2ac914612c2d5780630e89341c14612b4c5780631916558714612b2f57806322dcb0a714612ad15780632a55205a14612a175780632eb2c2d61461299557806347df1fdf146128a15780634e1273f4146127655780634f558e79146127395780635f453050146123f357806365e909d6146122025780636b915fe3146121ac57806371130b331461204e578063715018a614611ff157806371b38f0714611f675780637e608e9114611e4757806382f57d2714611de75780638da5cb5b14611dc05780639351f4ed1461128157806395d89b41146111995780639852595c146111605780639b642de1146110f65780639ebeef5914610fc7578063a22cb46514610e28578063a3f8eace14610dfc578063aada600b14610907578063aeb61fea1461077b578063b390c0ab14610529578063b8f7300314610410578063bd85b039146103e6578063df745d2814610380578063e33b7de314610361578063e985e9c51461030c578063ef8d10f5146102bf578063f242432a146102675763f2fde38b146101d457600080fd5b34610264576020366003190112610264576101ed6132a6565b6101f56136d4565b6001600160a01b038116156102105761020d9061372c565b80f35b60405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b6064820152608490fd5b80fd5b50346102645760a0366003190112610264576102816132a6565b6102896132bc565b90608435916001600160401b0383116102bb576102ad61020d9336906004016134fd565b916064359160443591614ac3565b8380fd5b5034610264576020366003190112610264576102f46040610308926102e2614a2e565b50600435815261013160205220613cbe565b604051918291602083526020830190613654565b0390f35b5034610264576040366003190112610264576103266132a6565b60406103306132bc565b926001600160a01b0380931681526066602052209116600052602052602060ff604060002054166040519015158152f35b5034610264578060031936011261026457602061013554604051908152f35b5034610264576020366003190112610264576004356001600160401b0381116103e2576103b19036906004016133f0565b825b8181106103be578380f35b806103dc6103d76103d26001948688613ea7565b6139d5565b614483565b016103b3565b5080fd5b50346102645760203660031901126102645760406020916004358152609783522054604051908152f35b50346102645760603660031901126102645760043561042d6132bc565b604435916001600160601b0383168093036105245761044a6136d4565b610458612710841115613bbd565b6001600160a01b038092169283156104df577fe361b60b9164428d036a601ec08552e653bfe8c44389b8a4ebfd47281eb8741a936060936040519061049c8261330c565b828252602082019084825285895260fc60205260408920925116906001600160601b0360a01b905160a01b1617905560405192835260208301526040820152a180f35b60405162461bcd60e51b815260206004820152601b60248201527f455243323938313a20496e76616c696420706172616d657465727300000000006044820152606490fd5b600080fd5b50346102645761053836613420565b909160ff610130541615610769573315610718576105558361445e565b61055e8361445e565b938260405161056c8161336c565b52825b8251811015610616576105828184613820565b5161058d8288613820565b5190808652609760208181526040882054928484106105c0578852526040862091900390556105bb906137fb565b61056f565b60405162461bcd60e51b815260048101839052602860248201527f455243313135353a206275726e20616d6f756e74206578636565647320746f74604482015267616c537570706c7960c01b6064820152608490fd5b838286818352602060658152604084203360005281526040600020548281106106c757829084865260658352604086203360005283520360406000205583604051848152838382015233907fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f6260403392a4836040516106948161336c565b526040519283528201527fde3ca466246b0da455138dbea78dacd91d3c40dc98d5846ff0193bf67c24b0e760403392a280f35b60405162461bcd60e51b8152600481018390526024808201527f455243313135353a206275726e20616d6f756e7420657863656564732062616c604482015263616e636560e01b6064820152608490fd5b60405162461bcd60e51b815260206004820152602360248201527f455243313135353a206275726e2066726f6d20746865207a65726f206164647260448201526265737360e81b6064820152608490fd5b60405163fa32799b60e01b8152600490fd5b5034610264576003196040368201126103e2576004356001600160401b0360243581811161090357604081600401948236030112610903576107bb6136d4565b61012f548310156108f1578285526101319360209480865263ffffffff604088205460401c166108df576107ee82613ec4565b848752855260408620600581016108058380613895565b91908683116108cb5761081883836139a1565b908952878920895b8381106108b15750505050906024600661083d9301930190613895565b92831161089d5761084e83836139a1565b908552838520855b83811061088b57867f71c8525fc38b77b64a66d848a818337505e69f1eacce1994cc6ca727e16d78c28787604051908152a180f35b82358282015591850191600101610856565b634e487b7160e01b86526041600452602486fd5b6001908a6108be856139d5565b9401938184015501610820565b634e487b7160e01b8a52604160045260248afd5b60405163fa2844a560e01b8152600490fd5b60405163c1ab6dc160e01b8152600490fd5b8480fd5b5034610264576003196040368201126103e2576001600160401b03602435116103e2576101209060243536030112610264576109416136d4565b61012f5460043510156108f157600435815261013160205261096560408220613cbe565b63ffffffff604082015116610100820151918115159081610d7d575b506108df576109ab6109976084602435016138ca565b6109a560a4602435016138ca565b90613e72565b60043583526101316020526040832063ffffffff6109cd6024356004016138ca565b1663ffffffff19825416178155610a0c6109ea60248035016138ca565b825467ffffffff00000000191660209190911b67ffffffff0000000016178255565b610a3d610a1d6044602435016138ca565b825463ffffffff60401b191660409190911b63ffffffff60401b16178255565b606460243501356001820155610a9f6002820163ffffffff610a636084602435016138ca565b1663ffffffff19825416178155610a7e60a4602435016138ca565b67ffffffff0000000082549160201b169067ffffffff000000001916179055565b60c460243501356003820155610abf60e4602435016024356004016138db565b906001600160401b03821161089d578190610aea82610ae160048701546132d2565b60048701613924565b8690601f8311600114610d11578792610d06575b50508160011b916000199060031b1c19161760048201555b6005810190610b3061010460243501602435600401613880565b91610b3b8380613895565b91906001600160401b038311610cf257610b5583836139a1565b90875260208720875b838110610cd757505050506006610b7b9101916020810190613895565b91906001600160401b03831161089d57610b9583836139a1565b90855260208520855b838110610cc3578686610bda876004358452610131602052604084209063ffffffff60401b82549160401b169063ffffffff60401b1916179055565b60408220600581018251908151916001600160401b03831161089d57602090610c0384846139a1565b0190855260208520855b838110610ca65760208601518051889160068801906001600160401b038311610c9257602090610c3d84846139a1565b0190835260208320835b838110610c7e57847f4040cd6ff4eef67e86ab078c16c2514c123f7b8782aa574307eaf34c726f3ef560206040516004358152a180f35b600190602084519401938184015501610c47565b634e487b7160e01b84526041600452602484fd5b60019060206001600160a01b038551169401938184015501610c0d565b600190602084359401938184015501610b9e565b6001906020610ce5856139d5565b9401938184015501610b5e565b634e487b7160e01b88526041600452602488fd5b013590503880610afe565b60048501885260208820889450915b601f1984168510610d65576001945083601f19811610610d4b575b505050811b016004820155610b16565b0135600019600384901b60f8161c19169055388080610d3b565b81810135835560209485019460019093019201610d20565b9050610d8d6024356004016138ca565b63ffffffff8083511691161490811591610dd6575b8115610db0575b5038610981565b905063ffffffff8060a0610dc860a4602435016138ca565b930151169116141538610da9565b9050610de66084602435016138ca565b63ffffffff806080840151169116141590610da2565b5034610264576020366003190112610264576020610e20610e1b6132a6565b614a7b565b604051908152f35b503461026457604036600319011261026457610e426132a6565b60243590811515809203610524576daaeb6d7670e522a718067333cd4e803b610f23575b506001600160a01b031690813314610ecc5733835260666020526040832082600052602052604060002060ff1981541660ff83161790556040519081527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3160203392a380f35b60405162461bcd60e51b815260206004820152602960248201527f455243313135353a2073657474696e6720617070726f76616c20737461747573604482015268103337b91039b2b63360b91b6064820152608490fd5b604051633185c44d60e21b81523060048201526001600160a01b038316602482015290602090829060449082905afa908115610fbc578491610f8e575b5015610f6c5738610e66565b604051633b79c77360e21b81526001600160a01b039091166004820152602490fd5b610faf915060203d8111610fb5575b610fa78183613387565b810190614aab565b38610f60565b503d610f9d565b6040513d86823e3d90fd5b503461026457806003193601126102645761012f54610fe581613436565b90610ff36040519283613387565b808252601f1961100282613436565b01835b8181106110cc575050825b81811061108c57505060405190602092838301848452825180915260408401948060408360051b870101940192955b82871061104c5785850386f35b909192938280600192603f1989820301855287519082806110768451604085526040850190613654565b930151910152960192019601959291909261103f565b806110c79185528060206101318152604087206110b36110ac8489613820565b5191613cbe565b90526110bf8287613820565b5101526137fb565b611010565b6020906040516110db8161330c565b6110e3614a2e565b8152828781830152828701015201611005565b5034610264576020366003190112610264576004356001600160401b0380821161115c573660238301121561115c57816004013590811161115c57366024828401011161115c5761020d916111579161114d6136d4565b60243692016134c6565b613a8a565b8280fd5b50346102645760203660031901126102645760406020916001600160a01b036111876132a6565b16815261013483522054604051908152f35b5034610264578060031936011261026457604051600061012e80546111bd816132d2565b8085529160019180831690811561125757506001146111fb575b610308856111e781870382613387565b6040519182916020835260208301906133cb565b600090815292507fbdaadd9f750d0166045bf387a364eadd28ba243e04512a47282aa5147a68e37f5b82841061123f5750505081016020016111e7826103086111d7565b80546020858701810191909152909301928101611224565b869550610308969350602092506111e794915060ff191682840152151560051b82010192936111d7565b5034610264576003199061014036830112610264576004356001600160401b0381116103e2576112b59036906004016134fd565b906024356001600160401b0381116103e2576112d59036906004016134fd565b926044356001600160401b03811161115c576112f59036906004016134fd565b926064356001600160401b0381116102bb576113159036906004016133f0565b90926040366083190112610903576001600160401b0360c435116109035760409060c435360301126102bb5760e435928315158403610903576001600160a01b0361010435166101043503610903576001600160a01b036101243516610124350361090357845460ff8160081c161596878098611db3575b8015611d9c575b15611d405760ff19821660011787556113c79188611d2f575b5061115760ff885460081c166113c281613a2a565b613a2a565b6113db60ff865460081c166113c281613a2a565b6113e43361372c565b60648211611d1d576113fa60c435600401613ec4565b845b8281106119c457505061012f55611418600460c4350180613895565b906001600160401b0382116119875761143082613960565b6101368552845b82811061199b57505050611455602460c4350160c435600401613895565b906001600160401b0382116119875761146d826139e9565b6101378552845b828110611965575050508051906001600160401b038211610c9257819061149d61012d546132d2565b601f8111611916575b50602090601f831160011461188c578592611881575b50508160011b916000199060031b1c19161761012d555b83516001600160401b03811161186d576114ef61012e546132d2565b601f8111611813575b506020601f821160011461178c5783949582939492611781575b50508160011b916000199060031b1c19161761012e555b6101309060ff8019835416911515161790556084356001600160a01b03811681036103e25760a435906001600160601b038216820361115c579061156c91613c1c565b6115786101043561372c565b610124356001600160a01b03161580156117795781905b61159f60ff845460081c16613a2a565b6daaeb6d7670e522a718067333cd4e91823b6115f8575b505050906115c15780f35b61ff001981541681557f7f26b83ff96e1f2b6a682f133852f6798a09c465da95921460cefb3847402498602060405160018152a180f35b60405163c3c5a54760e01b815230600482015260208160248188885af190811561176e578591611750575b506115b657156116a2575090818193923b156103e257604051633e9f1edf60e11b8152306004820152610124356001600160a01b031660248201529082908290604490829084905af1801561169757611683575b50505b903880806115b6565b61168c9061333d565b6103e2578138611677565b6040513d84823e3d90fd5b61170a5790818193923b156103e25760405163a0af290360e01b8152306004820152610124356001600160a01b031660248201529082908290604490829084905af18015611697576116f6575b505061167a565b6116ff9061333d565b6103e25781386116ef565b803b156103e257818091602460405180948193632210724360e11b83523060048401525af1801561169757611741575b509061167a565b61174a9061333d565b3861173a565b611768915060203d8111610fb557610fa78183613387565b38611623565b6040513d87823e3d90fd5b60019061158f565b015190503880611512565b61012e84527fbdaadd9f750d0166045bf387a364eadd28ba243e04512a47282aa5147a68e37f90845b601f19841681106117fb575060019394959683601f198116106117e2575b505050811b0161012e55611529565b015160001960f88460031b161c191690553880806117d3565b9091602060018192858b0151815501930191016117b5565b61185d9061012e85527fbdaadd9f750d0166045bf387a364eadd28ba243e04512a47282aa5147a68e37f601f840160051c81019160208510611863575b601f0160051c019061390d565b386114f8565b9091508190611850565b634e487b7160e01b83526041600452602483fd5b0151905038806114bc565b925061012d85527f193a3ae4da5049eb74cee39e4cf5827f7ce7b1d1d1775ef1c6311eb60558e6d59085935b601f19841685106118fb576001945083601f198116106118e2575b505050811b0161012d556114d3565b015160001960f88460031b161c191690553880806118d3565b818101518355602094850194600190930192909101906118b8565b61195f9061012d87527f193a3ae4da5049eb74cee39e4cf5827f7ce7b1d1d1775ef1c6311eb60558e6d5601f850160051c8101916020861061186357601f0160051c019061390d565b386114a6565b600190602083359301928160008051602061554e833981519152015501611474565b634e487b7160e01b85526041600452602485fd5b60019060206119a9846139d5565b9301928160008051602061556e833981519152015501611437565b6119e66119e06119d583868661385d565b610100810190613880565b80613895565b9050611d02575b6080611a04816119fe84878761385d565b016138ca565b90611a1a60a0926109a5846119fe878a8a61385d565b611ae1611a2884878761385d565b91848a52610131602052610a7e60408b209463ffffffff80611a49876138ca565b169063ffffffff199182895416178855611a8a611a68602089016138ca565b895467ffffffff00000000191660209190911b67ffffffff0000000016178955565b611ab9611a99604089016138ca565b895463ffffffff60401b191660409190911b63ffffffff60401b16178955565b60608701356001890155611ad2600289019588016138ca565b169084541617835584016138ca565b60c08101356003830155611af860e08201826138db565b906001600160401b0382116108cb57611b1882610ae160048701546132d2565b8990601f8311600114611c9157611b559392918b9183611c86575b50508160011b916000199060031b1c1916176004840155610100810190613880565b611b5f8180613895565b906001600160401b0382116108cb576005840190611b7d83836139a1565b908a5260208a208a5b838110611c6b5750505050806020611b9f920190613895565b916001600160401b038311611c575760060190611bbc83836139a1565b90885260208820885b838110611c43575050508187525061013160205260408620805463ffffffff60401b1916905560019080611c07611bfd82878761385d565b60e08101906138db565b9081604051928392833781018a81520390207f2031bb75fe7acfeb75a155106919ca62ef2e240732a3bf6035ce09f71698833e8980a3016113fc565b600190602084359401938184015501611bc5565b634e487b7160e01b89526041600452602489fd5b6001906020611c79856139d5565b9401938184015501611b86565b013590503880611b33565b600485018b5260208b20918b5b601f1985168110611cea5750918391600193611b559695601f19811610611cd0575b505050811b0160048401556119d5565b0135600019600384901b60f8161c19169055388080611cc0565b90926020600181928686013581550194019101611c9e565b611d18611d136119d583868661385d565b613ec4565b6119ed565b604051633a4733d960e11b8152600490fd5b61ffff1916610101178755386113ad565b60405162461bcd60e51b815260206004820152602e60248201527f496e697469616c697a61626c653a20636f6e747261637420697320616c72656160448201526d191e481a5b9a5d1a585b1a5e995960921b6064820152608490fd5b50303b1580156113945750600160ff831614611394565b50600160ff83161061138d565b503461026457806003193601126102645760206001600160a01b0360c95416604051908152f35b50604036600319011261026457600435611dff613630565b90808352610131602052611e1560408420613cbe565b916060830151611e355763ffffffff602061020d94015116913433614612565b604051634d0ee1f560e11b8152600490fd5b5034610264576003196020368201811361115c576001600160401b03916004358381116109035760408160040192823603011261090357611e866136d4565b611e8f82613ec4565b611e998280613895565b90858211611f5357611eaa82613960565b6101368752865b828110611f2b57505050906024611ec9920190613895565b928311610c9257611ed9836139e9565b90835b838110611f0b57847fb855aa79dff5fe918a28a8a1d8101db624120176786f8e2658f354b0e68654d08180a180f35b823560008051602061554e83398151915282015591810191600101611edc565b60019086611f38846139d5565b9301928160008051602061556e833981519152015501611eb1565b634e487b7160e01b87526041600452602487fd5b503461026457602036600319011261026457600435611f846136d4565b808252610131602052604082209081549063ffffffff92838316156108f15763ffffffff198316604093841c949094169384179055815190815263ffffffff90921660208301527fe7ff034533cbe8553f05d7bfe28543225de5f9589f0637e2e851c8fad322fd4991a180f35b503461026457806003193601126102645761200a6136d4565b806001600160a01b0360c9546001600160601b0360a01b811660c955167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a380f35b50608036600319011261026457600435612066613630565b61206e61361d565b906064356001600160401b0381116109035761208e9036906004016133f0565b8486526020610131815260019081604089200154938415611e3557604051828101903360601b825263ffffffff60e01b8960e01b166034820152601881526120d58161330c565b519020906120e285613436565b946120f06040519687613387565b8086528386019060051b8201913683116121a85785949392915b828210612196575050509389935b612143575b50505050036121315761020d923433614612565b6040516309bde33960e01b8152600490fd5b9091929381518510156121905761215a8583613820565b51908181101561217f578a52825261217660408a205b946137fb565b92919082612118565b908a52825261217660408a20612170565b9361211d565b8135815286955090840190840161210a565b8b80fd5b506060366003190112610264576121c16132a6565b602435906121cd61361d565b8284526101316020526121e260408520613cbe565b926060840151611e355763ffffffff602061020d95015116923490614612565b5034610264576060366003190112610264576024356001600160401b0381116103e2576122339036906004016133f0565b906044356001600160401b0381116102bb576122539036906004016133f0565b9161225c6136d4565b61012f5460043510156108f15784918484036123e1579060049492943586526101316020526040862086925b8584106122c357877f71cc7095cc35ed4701c217a8efb440732eb0737da67f6548c008ac26fba954646040888a82519182526020820152a180f35b909192939582549063ffffffff6122f16122e66122e1898c8a613ea7565b6138ca565b828560401c16613f5d565b921680151590816123d1575b506123bf5761232a61234492859063ffffffff60401b82549160401b169063ffffffff60401b1916179055565b63ffffffff61233d6122e1888b89613ea7565b1690613eb7565b936123536103d2828885613ea7565b63ffffffff6123666122e1848b89613ea7565b16604051918260208101106001600160401b036020850111176123ab579161239f9160019493602083016040528c835260043590613f75565b01959395929190612288565b634e487b7160e01b8b52604160045260248bfd5b6040516352df9fe560e01b8152600490fd5b905063ffffffff831611386122fd565b60405163e6dcad7760e01b8152600490fd5b5034610264576003196020368201126103e2576001600160401b03600435116103e25761012090600435360301126102645761242d6136d4565b6124456119e061010460043501600435600401613880565b905061271c575b61246b61245d6084600435016138ca565b6109a560a4600435016138ca565b61012f548082526101316020526040822063ffffffff61248f6004356004016138ca565b1663ffffffff198254161781556124ad6109ea6024600435016138ca565b6124be610a1d6044600435016138ca565b6064600435013560018201556124ff6002820163ffffffff6124e46084600435016138ca565b1663ffffffff19825416178155610a7e60a4600435016138ca565b60c46004350135600382015561251f60e4600435016004356004016138db565b906001600160401b03821161198757819061254182610ae160048701546132d2565b8590601f83116001146126b05786926126a5575b50508160011b916000199060031b1c19161760048201555b600581019061258761010460043501600435600401613880565b916125928380613895565b91906001600160401b038311611f53576125ac83836139a1565b90865260208620865b83811061268a575050505060066125d29101916020810190613895565b91906001600160401b038311611987576125ec83836139a1565b90845260208420845b8381106126765785858082526101316020526040822063ffffffff60401b19815416905561262561012f546137fb565b61012f5561263d60e4600435016004356004016138db565b9081604051928392833781018481520390207f2031bb75fe7acfeb75a155106919ca62ef2e240732a3bf6035ce09f71698833e8380a380f35b6001906020843594019381840155016125f5565b6001906020612698856139d5565b94019381840155016125b5565b013590503880612555565b60048501875260208720879450915b601f1984168510612704576001945083601f198116106126ea575b505050811b01600482015561256d565b0135600019600384901b60f8161c191690553880806126da565b818101358355602094850194600190930192016126bf565b612734611d1361010460043501600435600401613880565b61244c565b503461026457602036600319011261026457604060209160043581526097835220541515604051908152f35b5034610264576040366003190112610264576001600160401b0360043581811161115c576127979036906004016135af565b9060243590811161115c576127b090369060040161344d565b815181510361284a578151926127c584613436565b936127d36040519586613387565b8085526127e2601f1991613436565b013660208601375b8251811015612834578061281f6001600160a01b0361280c61282f9487613820565b51166128188386613820565b5190613776565b6128298287613820565b526137fb565b6127ea565b604051602080825281906103089082018761351b565b60405162461bcd60e51b815260206004820152602960248201527f455243313135353a206163636f756e747320616e6420696473206c656e677468604482015268040dad2e6dac2e8c6d60bb1b6064820152608490fd5b50346102645780600319360112610264576128ba614a15565b50604051906128c88261330c565b604051908161013681815491828652602080960190855260008051602061556e83398151915292855b878282106129765750505061290892500382613387565b83526040519081809261013790858254918281520191845260008051602061554e833981519152935b868282106129605750505061294892500382613387565b8183015261030860405192828493845283019061354f565b8554845260019586019587955093019201612931565b85546001600160a01b03168452600195860195879550930192016128f1565b50346102645760a0366003190112610264576129af6132a6565b6129b76132bc565b6001600160401b039190604435838111610903576129d990369060040161344d565b606435848111612a13576129f190369060040161344d565b91608435948511612a1357612a0d61020d9536906004016134fd565b93615033565b8580fd5b5034610264576040612a2836613420565b9290815260fc6020522060405190612a3f8261330c565b54916001600160a01b03918284169384825260a01c60208201529215612aa4575b612a7b612710916001600160601b036020860151169061384a565b0491511661030860405192839283602090939291936001600160a01b0360408201951681520152565b9150612710612a7b604051612ab88161330c565b60fb54848116825260a01c602082015293915050612a60565b5034610264578060031936011261026457612aea6136d4565b7f1509137b40df48e8ef9596f9db16b632b15353d0e0688d9f23221953eb0328dd602061013080549060ff8083161516809260ff19161790556040519015158152a180f35b50346102645760203660031901126102645761020d6103d76132a6565b5034610264576020806003193601126103e257604051918281606754612b71816132d2565b93848452600191868382169182600014612c0b575050600114612bb1575b5050612b9d92500383613387565b6103086040519282849384528301906133cb565b90859250606782527f9787eeb91fe3101235e4a76063c7023ecb40f923f97916639c598592fa30d6ae5b858310612bf3575050612b9d93508201013880612b8f565b80548389018501528794508693909201918101612bdb565b9250935050612b9d94915060ff191682840152151560051b8201013880612b8f565b5034610264576020366003190112610264576004356001600160401b0381116103e257612c5e9036906004016133f0565b9190612c686136d4565b61012f549282915b818310612c8057838561012f5580f35b612c916119e06119d585858561385d565b905061308c575b612ca383838361385d565b94610120958681360312612a13576040519687018781106001600160401b03821117611f5357604052612cd581613643565b8752612ce360208201613643565b6020880152612cf460408201613643565b60408801526060908181013582890152608091612d12838301613643565b838a015260a090612d24828401613643565b828b015260c09283810135848c01526001600160401b0360e08201351161308457612d553660e083013583016134fd565b60e08c0152610100810135906001600160401b03821161308857016040813603126130845760405190612d878261330c565b80356001600160401b0381116121a857612da490369083016135af565b825260208101356001600160401b0381116121a85793612ea7938d93612dd663ffffffff948f9b9a999836910161344d565b6020820152610100850152612df683888601511684848701511690613e72565b826040899a80828801528a815261013160205220978186511692821993848b5416178a55612e47836020890151168b9067ffffffff0000000082549160201b169067ffffffff000000001916179055565b6040878101518b5463ffffffff60401b191690851690911b63ffffffff60401b16178a5586015160018a01556002890195015116908454161783558c01511667ffffffff0000000082549160201b169067ffffffff000000001916179055565b880151600382015560e08801518051906001600160401b038211611c57578190612ed882610ae160048701546132d2565b602090601f8311600114613015578a9261300a575b50508160011b916000199060031b1c19161760048201555b61010088015180518051906001600160401b0382116108cb5760206005850191612f2f84846139a1565b01908a5260208a208a5b838110612fed5750505050602001518051916001600160401b038311611c575760066020910191612f6a84846139a1565b0190885260208820885b838110612fd9575050505060e06001612f8f612fa8936137fb565b96019701516020604051928284809451938492016133a8565b81010390207f2031bb75fe7acfeb75a155106919ca62ef2e240732a3bf6035ce09f71698833e8680a3939193612c70565b600190602084519401938184015501612f74565b60019060206001600160a01b038551169401938184015501612f39565b015190503880612eed565b9250600484018a5260208a20908a935b601f1984168510613069576001945083601f19811610613050575b505050811b016004820155612f05565b015160001960f88460031b161c19169055388080613040565b81810151835560209485019460019093019290910190613025565b8980fd5b8a80fd5b61309d611d136119d585858561385d565b612c98565b5034610264578060031936011261026457604051908061012d908154906130c8826132d2565b8086529260019280841690811561314c57506001146130f2575b610308866111e781880382613387565b815292507f193a3ae4da5049eb74cee39e4cf5827f7ce7b1d1d1775ef1c6311eb60558e6d55b8284106131345750505081016020016111e782610308386130e2565b80546020858701810191909152909301928101613118565b9050869550610308969350602092506111e794915060ff191682840152151560051b8201019293386130e2565b5034610264576040366003190112610264576131936132a6565b6024356001600160601b038116918282036102bb577f8039bd6e4e7dba001c8840eb2e118d9d131246faa7d0d04335f7305127ec0b10926131de6040936131d86136d4565b83613c1c565b6001600160a01b038351921682526020820152a180f35b50346102645760203660031901126102645760043563ffffffff60e01b81168091036103e25760209063152a902d60e11b811490811561323b575b506040519015158152f35b636cdb3d1360e11b81149150811561326d575b811561325c575b5082613230565b6301ffc9a760e01b14905082613255565b6303a24d0760e21b8114915061324e565b5034610264576040366003190112610264576020610e2061329d6132a6565b60243590613776565b600435906001600160a01b038216820361052457565b602435906001600160a01b038216820361052457565b90600182811c92168015613302575b60208310146132ec57565b634e487b7160e01b600052602260045260246000fd5b91607f16916132e1565b604081019081106001600160401b0382111761332757604052565b634e487b7160e01b600052604160045260246000fd5b6001600160401b03811161332757604052565b61012081019081106001600160401b0382111761332757604052565b602081019081106001600160401b0382111761332757604052565b90601f801991011681019081106001600160401b0382111761332757604052565b60005b8381106133bb5750506000910152565b81810151838201526020016133ab565b906020916133e4815180928185528580860191016133a8565b601f01601f1916010190565b9181601f84011215610524578235916001600160401b038311610524576020808501948460051b01011161052457565b6040906003190112610524576004359060243590565b6001600160401b0381116133275760051b60200190565b81601f820112156105245780359161346483613436565b926134726040519485613387565b808452602092838086019260051b820101928311610524578301905b82821061349c575050505090565b8135815290830190830161348e565b6001600160401b03811161332757601f01601f191660200190565b9291926134d2826134ab565b916134e06040519384613387565b829481845281830111610524578281602093846000960137010152565b9080601f8301121561052457816020613518933591016134c6565b90565b90815180825260208080930193019160005b82811061353b575050505090565b83518552938101939281019260010161352d565b9190916040830192815190604081528151809552606081019260208093016000965b80881061358f5750506135189495508201519181840391015261351b565b909484806001926001600160a01b03895116815201960197019690613571565b81601f82011215610524578035916135c683613436565b926135d46040519485613387565b808452602092838086019260051b820101928311610524578301905b8282106135fe575050505090565b81356001600160a01b03811681036105245781529083019083016135f0565b6044359063ffffffff8216820361052457565b6024359063ffffffff8216820361052457565b359063ffffffff8216820361052457565b906135189163ffffffff8082511683528060208301511660208401528060408301511660408401526060820151606084015280608083015116608084015260a08201511660a083015260c081015160c08301526136c060e08201516101208060e08601528401906133cb565b91610100809201519181840391015261354f565b6001600160a01b0360c9541633036136e857565b606460405162461bcd60e51b815260206004820152602060248201527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e65726044820152fd5b60c954906001600160a01b0380911691826001600160601b0360a01b82161760c955167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0600080a3565b6001600160a01b03169081156137a357600052606560205260406000209060005260205260406000205490565b60405162461bcd60e51b815260206004820152602a60248201527f455243313135353a2061646472657373207a65726f206973206e6f742061207660448201526930b634b21037bbb732b960b11b6064820152608490fd5b600019811461380a5760010190565b634e487b7160e01b600052601160045260246000fd5b80518210156138345760209160051b010190565b634e487b7160e01b600052603260045260246000fd5b8181029291811591840414171561380a57565b91908110156138345760051b8101359061011e1981360301821215610524570190565b903590603e1981360301821215610524570190565b903590601e198136030182121561052457018035906001600160401b03821161052457602001918160051b3603831361052457565b3563ffffffff811681036105245790565b903590601e198136030182121561052457018035906001600160401b0382116105245760200191813603831361052457565b818110613918575050565b6000815560010161390d565b9190601f811161393357505050565b61395e926000526020600020906020601f840160051c8301931061186357601f0160051c019061390d565b565b600160401b8111613327576101369081549080835581811061398157505050565b61395e9260005260008051602061556e833981519152918201910161390d565b90600160401b8111613327578154908083558181106139bf57505050565b61395e926000526020600020918201910161390d565b356001600160a01b03811681036105245790565b600160401b81116133275761013790815490808355818110613a0a57505050565b61395e9260005260008051602061554e833981519152918201910161390d565b15613a3157565b60405162461bcd60e51b815260206004820152602b60248201527f496e697469616c697a61626c653a20636f6e7472616374206973206e6f74206960448201526a6e697469616c697a696e6760a81b6064820152608490fd5b9081516001600160401b03811161332757613aa66067546132d2565b601f8111613b6e575b50602080601f8311600114613aec5750819293600092613ae1575b50508160011b916000199060031b1c191617606755565b015190503880613aca565b90601f1983169460676000527f9787eeb91fe3101235e4a76063c7023ecb40f923f97916639c598592fa30d6ae926000905b878210613b56575050836001959610613b3d575b505050811b01606755565b015160001960f88460031b161c19169055388080613b32565b80600185968294968601518155019501930190613b1e565b613bb79060676000527f9787eeb91fe3101235e4a76063c7023ecb40f923f97916639c598592fa30d6ae601f840160051c8101916020851061186357601f0160051c019061390d565b38613aaf565b15613bc457565b60405162461bcd60e51b815260206004820152602a60248201527f455243323938313a20726f79616c7479206665652077696c6c206578636565646044820152692073616c65507269636560b01b6064820152608490fd5b906001600160a01b036001600160601b03821692613c3e612710851115613bbd565b16918215613c79576020604051613c548161330c565b848152015260a01b73ffffffffffffffffffffffffffffffffffffffff19161760fb55565b60405162461bcd60e51b815260206004820152601960248201527f455243323938313a20696e76616c6964207265636569766572000000000000006044820152606490fd5b906040918251613ccd81613350565b8093825463ffffffff918282168452826020928181851c1684870152821c168185015260019283860154606086015260028601548181166080870152831c1660a0850152600385015460c085015260048501815190816000825492613d31846132d2565b93848452878982169182600014613e52575050600114613e11575b50613d5992500382613387565b60e085015280519460058101613d6e8761330c565b82519081858254918281520191600052856000209060005b8888838310613df657505050505090613da481600694930382613387565b87520190518093838354928381520192600052836000209160005b818110613de3575050505090613ddc836101009594930383613387565b8401520152565b8354855293850193928201928201613dbf565b84546001600160a01b03168652909401939283019201613d86565b915050600052818480600020876000915b858310613e39575050613d59935082010138613d4c565b8091929450548385880101520191018590878593613e22565b60ff191685820152613d5995151560051b8501019250389150613d4c9050565b9063ffffffff8091169182613e8657505050565b168110613e95574211613e9557565b60405163427f0ccd60e11b8152600490fd5b91908110156138345760051b0190565b9190820180921161380a57565b600090613ed18180613895565b91602081019150613ee28282613895565b841480159150613f53575b613f0b57839291905b828510613f1d575050506064915003613f0b57565b604051630d5ca8b560e31b8152600490fd5b909192613f3485613f2e8585613895565b90613ea7565b35908115613f0b57600191613f4891613eb7565b940193929190613ef6565b5060048311613eed565b91909163ffffffff8080941691160191821161380a57565b93909192936001600160a01b03811694851561418657613f948461445e565b93613f9e8661445e565b9660005b8651811015613fe95780613fb9613fe4928b613820565b51613fc4828a613820565b516000526097602052613fdd6040600020918254613eb7565b90556137fb565b613fa2565b50929591945092955082600052602093606585526040958660002084600052865286600020614019848254613eb7565b9055836000885187815285898201527fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628a3392a43b61405b575b505050505050565b61409e9285926000885180968195829463f23a6e6160e01b9a8b85523360048601528560248601526044850152606484015260a0608484015260a48301906133cb565b03925af160009181614157575b506141295750506001906140bd61423e565b6308c379a0146140f5575b506140da57505b388080808080614053565b5162461bcd60e51b8152806140f1600482016142ca565b0390fd5b6140fd61425c565b908161410957506140c8565b6140f1845192839262461bcd60e51b8452600484015260248301906133cb565b6001600160e01b03191603905061414057506140cf565b5162461bcd60e51b8152806140f1600482016141f5565b614178919250843d861161417f575b6141708183613387565b8101906141d5565b90386140ab565b503d614166565b60405162461bcd60e51b815260206004820152602160248201527f455243313135353a206d696e7420746f20746865207a65726f206164647265736044820152607360f81b6064820152608490fd5b9081602091031261052457516001600160e01b0319811681036105245790565b60809060208152602860208201527f455243313135353a204552433131353552656365697665722072656a656374656040820152676420746f6b656e7360c01b60608201520190565b60009060033d1161424b57565b905060046000803e60005160e01c90565b600060443d1061351857604051600319913d83016004833e81516001600160401b03918282113d6024840111176142b9578184019485519384116142c1573d850101602084870101116142b9575061351892910160200190613387565b949350505050565b50949350505050565b60809060208152603460208201527f455243313135353a207472616e7366657220746f206e6f6e2d4552433131353560408201527f526563656976657220696d706c656d656e74657200000000000000000000000060608201520190565b9491909293813b61433b57505050505050565b600060209461438d966040519788968795869363f23a6e6160e01b9c8d86526001600160a01b03968780921660048801521660248601526044850152606484015260a0608484015260a48301906133cb565b0393165af16000918161443e575b5061441657505060016143ac61423e565b6308c379a0146143df575b6143c657388080808080614053565b60405162461bcd60e51b8152806140f1600482016142ca565b6143e761425c565b806143f257506143b7565b60405162461bcd60e51b8152602060048201529081906140f19060248301906133cb565b6001600160e01b031916146140cf5760405162461bcd60e51b8152806140f1600482016141f5565b61445791925060203d811161417f576141708183613387565b903861439b565b6040519061446b8261330c565b60018252602082016020368237825115613834575290565b61448c81614a7b565b80614495575050565b6101356144a3828254613eb7565b90556001600160a01b038216600090808252610134602052604082208381540190558247106145b2578180808581945af1903d156145ac573d906144e6826134ab565b916144f46040519384613387565b825260203d92013e5b1561454157604080516001600160a01b0393909316835260208301919091527fdf20fd1e76bc69d672e4814fafb2c449bba3a5369d8359adf9e05e6fde87b05691a1565b60405162461bcd60e51b815260206004820152603a60248201527f416464726573733a20756e61626c6520746f2073656e642076616c75652c207260448201527f6563697069656e74206d617920686176652072657665727465640000000000006064820152608490fd5b506144fd565b60405162461bcd60e51b815260206004820152601d60248201527f416464726573733a20696e73756666696369656e742062616c616e63650000006044820152606490fd5b9190916001600160401b038080941691160191821161380a57565b939061012f548310156108f157600090838252602095610131875260409384842090600393848301549463ffffffff9261464f848c16809861384a565b83036149ed57888554858d8183169283151594856149d0575b50505050506149bf5783168015159081614985575b50614974576002840154838116801515908161496a575b50614959578b1c8316801515908161494f575b5061493e5781614789575b5050928661476993614714846146f58c7f2e8ac5177a616f2aec08c3048f5021e4e9743ece034e8d83ba5caf76688bb4759d9c9b996147849b98548b1c16613f5d565b63ffffffff60401b82549160401b169063ffffffff60401b1916179055565b8184526101328b528584206001600160a01b0382169b8c86525285842080546001600160401b03614747868284166145f7565b16906001600160401b0319161790558551936147628561336c565b8452613f75565b5191825263ffffffff90921660208201529081906040820190565b0390a2565b60058401805490929015614854578b918354938960068801945b8682106147fb575050505050505092866147699361471461478497946146f58c7f2e8ac5177a616f2aec08c3048f5021e4e9743ece034e8d83ba5caf76688bb4759d9c9b995b96999b9c509c505094975050936146b2565b908561484b8e8e610133600196606461483d614831896001600160a01b038e6148258f84906149fd565b9054911b1c16996149fd565b9054908d1b1c8d61384a565b049583525220918254613eb7565b9055018e6147a3565b9150506101369a99989796959a908154918c5b8381106148ae57505050509285614769936147147f2e8ac5177a616f2aec08c3048f5021e4e9743ece034e8d83ba5caf76688bb4759a9b9c946146f58b6147849a996147e9565b815481101561492a576001600160a01b038160008051602061556e833981519152015416610137805483101561491557908f8b8f9161013361490d93600197968352606461483d8860008051602061554e83398151915201548c61384a565b905501614867565b50634e487b7160e01b8f52603260045260248ffd5b634e487b7160e01b8e52603260045260248efd5b875163914edb0f60e01b8152600490fd5b90504211386146a7565b885163914edb0f60e01b8152600490fd5b9050421038614694565b8751636c80554560e11b8152600490fd5b90508988526101328c528888206001600160a01b03871689528c526001600160401b036149b788828c8c2054166145f7565b16113861467d565b88516352df9fe560e01b8152600490fd5b83949550906149e193911c16613f5d565b161138858d828d614668565b885162bfc92160e01b8152600490fd5b80548210156138345760005260206000200190600090565b60405190614a228261330c565b60606020838281520152565b60405190614a3b82613350565b8160008082528060208301528060408301528060608301528060808301528060a083015260c0820152606060e0820152610100614a76614a15565b910152565b6001600160a01b0316600052610133602052604060002054610134602052604060002054810390811161380a5790565b90816020910312610524575180151581036105245790565b94939291906daaeb6d7670e522a718067333cd4e803b614d1a575b506001600160a01b0395868116963388148015614cf1575b614aff90614f17565b8216801597614b0e8915614f7a565b614b178561445e565b614b208761445e565b998215614c91575b614bc2575b5061395e97985060008581527fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62602091606583526040818180932086825285528a82822054614b7e82821015614fd4565b8b8352606587528383208884528752038282205589815260658552818120878252855220614bad8a8254613eb7565b9055888151938985528401523392a433614328565b969492909795939160005b8851811015614c7c57614be0818a613820565b51614beb828d613820565b5181600052609791602092808452604093846000205492848410614c275790614c22969594939291600052520390600020556137fb565b614bcd565b855162461bcd60e51b815260048101839052602860248201527f455243313135353a206275726e20616d6f756e74206578636565647320746f74604482015267616c537570706c7960c01b6064820152608490fd5b5091939598509193955061395e968897614b2d565b98959260009895929794919897885b8c8b51821015614ce057908b614cc482614cbd81614cdb96613820565b5192613820565b518c526097602052613fdd60408d20918254613eb7565b614ca0565b505092959891949750929598614b28565b50876000526066602052604060002033600052602052614aff60ff604060002054169050614af6565b6001600160a01b038088169033821480614db4575050604051633185c44d60e21b81523060048201523360248201529160209150829060449082905afa908115614da857600091614d8a575b5015614d725738614ade565b604051633b79c77360e21b8152336004820152602490fd5b614da2915060203d8111610fb557610fa78183613387565b38614d66565b6040513d6000823e3d90fd5b91989250908015614eee575b614dc990614f17565b8216801597614dd88915614f7a565b614de18561445e565b614dea8761445e565b998215614eac575b614e47575061395e97985060008581527fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62602091606583526040818180932086825285528a82822054614b7e82821015614fd4565b969492909795939160005b8851811015614c7c57614e65818a613820565b51614e70828d613820565b5181600052609791602092808452604093846000205492848410614c275790614ea7969594939291600052520390600020556137fb565b614e52565b98959260009895929794919897885b8c8b51821015614edd57908b614cc482614cbd81614ed896613820565b614ebb565b505092959891949750929598614df2565b50876000526066602052604060002033600052602052614dc960ff604060002054169050614dc0565b15614f1e57565b60405162461bcd60e51b815260206004820152602e60248201527f455243313135353a2063616c6c6572206973206e6f7420746f6b656e206f776e60448201526d195c881bdc88185c1c1c9bdd995960921b6064820152608490fd5b15614f8157565b60405162461bcd60e51b815260206004820152602560248201527f455243313135353a207472616e7366657220746f20746865207a65726f206164604482015264647265737360d81b6064820152608490fd5b15614fdb57565b60405162461bcd60e51b815260206004820152602a60248201527f455243313135353a20696e73756666696369656e742062616c616e636520666f60448201526939103a3930b739b332b960b11b6064820152608490fd5b9190946daaeb6d7670e522a718067333cd4e803b6153b2575b506001600160a01b03809316923384148015615389575b61506c90614f17565b82518551036153335786169586156150848115614f7a565b84156152f3575b615284575b60005b835181101561511c57806150aa6151179286613820565b51613fdd6150b8838a613820565b5191806000526065602090808252604092836000208c60005283528584600020546150e582821015614fd4565b826000528385528d86600020906000528552038460002055600052815281600020908d60005252600020918254613eb7565b615093565b509492939095604095818688518981527f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb6151598b83018961351b565b9180830360208201528061516e33948a61351b565b0390a43b61517e57505050505050565b6151be60006020946151e06151d1958a519889978896879563bc197c8160e01b9d8e8852336004890152602488015260a0604488015260a487019061351b565b600319938487830301606488015261351b565b918483030160848501526133cb565b03925af160009181615264575b5061524f57505060016151fe61423e565b6308c379a014615219575b6140da5750388080808080614053565b61522161425c565b8061522c5750615209565b825162461bcd60e51b8152602060048201529081906140f19060248301906133cb565b6001600160e01b0319160361414057506140cf565b61527d91925060203d811161417f576141708183613387565b90386151ed565b94919395929060005b85518110156152e7576152a08187613820565b516152ab828a613820565b5181600052609791602092808452604093846000205492848410614c2757906152e2969594939291600052520390600020556137fb565b61528d565b50909295939194615090565b959160009793959491885b875181101561532557806153156153209289613820565b51614cc4828b613820565b6152fe565b50919495939750919561508b565b60405162461bcd60e51b815260206004820152602860248201527f455243313135353a2069647320616e6420616d6f756e7473206c656e677468206044820152670dad2e6dac2e8c6d60c31b6064820152608490fd5b5083600052606660205260406000203360005260205261506c60ff604060002054169050615063565b6001600160a01b038085169033821480615428575050604051633185c44d60e21b81523060048201523360248201529160209150829060449082905afa908115614da85760009161540a575b5015614d72573861504c565b615422915060203d8111610fb557610fa78183613387565b386153fe565b91955091508015615524575b61543d90614f17565b82518551036153335786169586156154558115614f7a565b84156154ef575b615480575b60005b835181101561511c57806150aa61547b9286613820565b615464565b94919395929060005b85518110156154e35761549c8187613820565b516154a7828a613820565b5181600052609791602092808452604093846000205492848410614c2757906154de969594939291600052520390600020556137fb565b615489565b50909295939194615461565b959160009793959491885b875181101561551657806153156155119289613820565b6154fa565b50919495939750919561545c565b5083600052606660205260406000203360005260205261543d60ff60406000205416905061543456fe43dc304bb3613567eca51c4fb9e7f3128bc51bba882a32550e891d6cbd8a0fa139da2db355130acf428d669fbf1c14faa9d51399a25b793fc254bbbde66f02e2a2646970667358221220d59f690968b93a30540bb3900c196ac0fcd571daf23b9d1bae9d8428cae989cd64736f6c63430008110033"),
            rpc_url: String::from(""),
            openai_api_key: String::from(""),
            llm_postprocess: false,
            default: true,
            skip_resolving: true,
            include_solidity: true,
            include_yul: false,
            output: String::from(""),
            name: String::from(""),
            timeout: 10000,
            abi: None,

        })
        .await
        .expect("failed to decompile");
    }

    #[tokio::test]
    #[ignore]
    async fn heavy_integration_test() {
        let root_dir = PathBuf::from(env!("CARGO_MANIFEST_DIR"))
            .parent()
            .expect("no parent")
            .parent()
            .expect("no parent")
            .to_owned();

        // if the ./largest1k directory does not exist, download it from https://jbecker.dev/data/largest1k.tar.gz
        let dataset_dir = root_dir.join("largest1k");
        if !dataset_dir.exists() {
            eprintln!("dataset not found in root, skipping test");
            std::process::exit(0);
        }

        // list files in root_dir
        let contracts = std::fs::read_dir(dataset_dir)
            .expect("failed to read dataset directory")
            .map(|res| {
                // HashMap from filename (without extension) to bytecode (from serde_json::Value)
                res.map(|e| {
                    let path = e.path();
                    let filename = path
                        .file_stem()
                        .expect("no file stem")
                        .to_str()
                        .expect("no file stem")
                        .to_owned();

                    // read contents as json and parse to serde_json::Value
                    let contents_json: Value = serde_json::from_str(
                        &std::fs::read_to_string(path).expect("failed to read file"),
                    )
                    .expect("failed to parse json");
                    let bytecode = contents_json["code"].as_str().expect("no bytecode").to_owned();

                    (filename, bytecode)
                })
            })
            .collect::<Result<Vec<_>, std::io::Error>>()
            .expect("failed to collect files");

        // define flag checks
        let mut is_function_covered = false;
        let mut is_event_covered = false;
        let mut is_require_covered = false;
        let mut is_error_covered = false;

        let mut success_count = 0;
        let mut fail_count = 0;

        for (contract_address, bytecode) in contracts {
            println!("Testing contract: {contract_address}");
            let args = DecompilerArgsBuilder::new()
                .target(bytecode)
                .skip_resolving(true)
                .include_solidity(true)
                .timeout(10000)
                .build()
                .expect("failed to build args");

            let result = match decompile(args).await.map_err(|e| {
                eprintln!("failed to decompile {contract_address}: {e}");
                e
            }) {
                Ok(result) => {
                    success_count += 1;
                    result
                }
                Err(_) => {
                    fail_count += 1;
                    continue;
                }
            };

            let output = result.source.expect("decompile source is empty");

            // perform flag checks
            if output.contains("function Unresolved_") {
                is_function_covered = true;
            }
            if output.contains("event Event_") {
                is_event_covered = true;
            }
            if output.contains("require(") {
                is_require_covered = true;
            }
            if output.contains("error CustomError_") {
                is_error_covered = true;
            }

            let abi_serialized = serde_json::to_string(&result.abi).unwrap();
            let abi_deserialized = JsonAbi::from_json_str(&abi_serialized);
            assert!(abi_deserialized.is_ok());
        }

        // assert that all flags are true
        assert!(is_function_covered);
        assert!(is_event_covered);
        assert!(is_require_covered);
        assert!(is_error_covered);

        // assert 99% success rate
        assert!(
            success_count as f64 / (success_count + fail_count) as f64 > 0.99,
            "success rate is less than 99%"
        );
    }

    #[tokio::test]
    async fn test_decompile_extended_abi() {
        // Test that the extended ABI includes selector and signature fields
        let bytecode = "0x608060405234801561001057600080fd5b50600436106100365760003560e01c80636057361d1461003b5780638bab8dd514610057575b600080fd5b610055600480360381019061005091906101a3565b610087565b005b610071600480360381019061006c9190610158565b610091565b60405161007e91906101db565b60405180910390f35b8060008190555050565b6000816040516100a19190610181565b908152602001604051809103902060009054906101000a900460ff169050919050565b600080fd5b600080fd5b6000819050919050565b6100e2816100cf565b81146100ed57600080fd5b50565b6000813590506100ff816100d9565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f84011261012a576101296100ff565b5b8235905067ffffffffffffffff81111561014757610146610104565b5b60208301915083600182028301111561016357610162610109565b5b9250929050565b60008060208385031215610181576101806100c5565b5b600083013567ffffffffffffffff81111561019f5761019e6100ca565b5b6101ab85828601610114565b92509250509250929050565b6000602082840312156101cd576101cc6100c5565b5b60006101db848285016100f0565b91505092915050565b60008115159050919050565b6101fa816101e4565b82525050565b600060208201905061021560008301846101f1565b92915050565b600081519050919050565b600081905092915050565b60005b8381101561024f578082015181840152602081019050610234565b8381111561025e576000848401525b50505050565b600061026f8261021b565b6102798185610226565b9350610289818560208601610231565b80840191505092915050565b60006102a18284610264565b91508190509291505056fea264697066735822122001c9bb0054b2e989dde58e82a86834274d784bd6503669a5b973edc73f03fa9d64736f6c634300080f0033";

        let args = DecompilerArgsBuilder::new()
            .target(bytecode.to_string())
            .skip_resolving(true)
            .include_solidity(true)
            .timeout(10000)
            .build()
            .expect("failed to build args");

        let result = decompile(args).await.expect("failed to decompile");

        // Check that the standard ABI is valid
        let abi_serialized = serde_json::to_string(&result.abi).unwrap();
        let abi_deserialized = JsonAbi::from_json_str(&abi_serialized);
        assert!(abi_deserialized.is_ok());

        // Check that the extended ABI contains selector and signature fields
        let extended_abi = &result.abi_with_details;

        // The extended ABI is an array of ABI items
        assert!(extended_abi.is_array(), "Extended ABI should be an array");
        let abi_items = extended_abi.as_array().unwrap();
        assert!(!abi_items.is_empty(), "Extended ABI should contain items");

        // Group items by type
        let mut functions = Vec::new();
        let mut events = Vec::new();
        let mut errors = Vec::new();

        for item in abi_items {
            assert!(item.is_object());
            let item_obj = item.as_object().unwrap();

            if let Some(item_type) = item_obj.get("type").and_then(|v| v.as_str()) {
                match item_type {
                    "function" => functions.push(item_obj),
                    "event" => events.push(item_obj),
                    "error" => errors.push(item_obj),
                    _ => {}
                }
            }
        }

        // Check functions
        assert!(!functions.is_empty(), "Extended ABI should contain functions");
        for func_obj in &functions {
            // Verify selector field exists and is a string
            assert!(func_obj.contains_key("selector"), "Function should have a selector field");
            let selector = func_obj.get("selector").unwrap();
            assert!(selector.is_string(), "Selector should be a string");
            let selector_str = selector.as_str().unwrap();
            assert!(selector_str.starts_with("0x"), "Selector should start with 0x");
            assert_eq!(
                selector_str.len(),
                10,
                "Selector should be 10 characters (0x + 8 hex chars)"
            );

            // Verify signature field exists and is a string
            assert!(func_obj.contains_key("signature"), "Function should have a signature field");
            let signature = func_obj.get("signature").unwrap();
            assert!(signature.is_string(), "Signature should be a string");
            let sig_str = signature.as_str().unwrap();
            assert!(sig_str.contains("("), "Signature should contain opening parenthesis");
            assert!(sig_str.contains(")"), "Signature should contain closing parenthesis");
        }

        // Check events if present
        for event_obj in &events {
            // Events should have selector (topic0) and signature
            assert!(event_obj.contains_key("selector"), "Event should have a selector field");
            assert!(event_obj.contains_key("signature"), "Event should have a signature field");
        }

        // Check errors if present
        for error_obj in &errors {
            // Errors should have selector and signature
            assert!(error_obj.contains_key("selector"), "Error should have a selector field");
            assert!(error_obj.contains_key("signature"), "Error should have a signature field");
        }
    }
}
